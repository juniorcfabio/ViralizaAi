<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>PIX - Viralizaai (rápido)</title>
<meta name="supabase-url" content="https://ymmswnmietxoupeazmok.supabase.co">
<meta name="supabase-anon-key" content="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InltbXN3bm1pZXR4b3VwZWF6bW9rIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2ODY2NjcsImV4cCI6MjA4MDI2MjY2N30.yvCcvTnqAMsNz9itandg4lyxeEmhsukcbqfkWZnkeu4">
<style>
  body{font-family:Arial,Helvetica,sans-serif;padding:18px;background:#f5f7fb}
  .card{background:#fff;padding:16px;border-radius:10px;max-width:820px;margin:0 auto;box-shadow:0 8px 24px rgba(10,10,30,0.06)}
  .row{display:flex;gap:12px;align-items:center}
  .btn{background:#0b67ff;color:#fff;padding:10px 14px;border-radius:8px;border:0;cursor:pointer}
  .qr{width:220px;height:220px;border-radius:8px;border:1px solid #eee;display:flex;align-items:center;justify-content:center;background:#fff}
  input.readonly{width:100%;padding:10px;border-radius:8px;border:1px solid #eee;background:#fafafa;font-family:monospace}
</style>
</head>
<body>
  <div class="card">
    <h3>Pagamento — Viralizaai (rápido)</h3>

    <div>
      <label>Tipo:</label>
      <select id="type">
        <option value="product">Produto</option>
        <option value="plan">Plano</option>
      </select>
      <input id="idInput" placeholder="Cole product_id ou plan_id" style="width:60%;padding:8px;border-radius:8px;border:1px solid #ddd;margin-left:8px"/>
      <button id="fetchBtn" class="btn">Carregar preço</button>
    </div>

    <div style="margin-top:12px" id="info" hidden>
      <div class="row" style="justify-content:space-between">
        <div style="flex:1">
          <div><strong id="title">Título</strong></div>
          <div style="margin-top:8px">Valor: R$ <span id="price">0.00</span></div>
          <div style="margin-top:8px">
            <button id="payPix" class="btn">Pagar com PIX</button>
            <button id="payStripe" class="btn" style="background:#06c167;margin-left:8px">Pagar com Cartão (Stripe)</button>
          </div>
        </div>

        <div style="text-align:center">
          <div class="qr" id="qrPreview">Nenhum QR</div>
        </div>
      </div>

      <div style="margin-top:12px">
        <div>Payload PIX</div>
        <input id="payload" class="readonly" readonly/>
        <div style="margin-top:8px">
          <button id="copyPayload" class="btn">Copiar payload</button>
          <button id="copyLink" class="btn" style="background:#222;margin-left:8px">Copiar link</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/qrious@4.0.2/dist/qrious.min.js"></script>
  <script>
    (function(){
      // Configuração Supabase via meta tags
      const SUPABASE_URL = document.querySelector('meta[name="supabase-url"]')?.content || '';
      const SUPABASE_ANON_KEY = document.querySelector('meta[name="supabase-anon-key"]')?.content || '';

      const typeSelect = document.getElementById('type');
      const idInput = document.getElementById('idInput');
      const fetchBtn = document.getElementById('fetchBtn');
      const info = document.getElementById('info');
      const titleEl = document.getElementById('title');
      const priceEl = document.getElementById('price');
      const payPix = document.getElementById('payPix');
      const payStripe = document.getElementById('payStripe');
      const payloadInput = document.getElementById('payload');
      const qrPreview = document.getElementById('qrPreview');
      const copyPayload = document.getElementById('copyPayload');
      const copyLink = document.getElementById('copyLink');

      const qr = new QRious({ element: document.createElement('canvas'), size: 220 });

      function moneyToString(v){ return Number(v||0).toFixed(2); }

      async function fetchPrice(){
        const type = typeSelect.value;
        const id = idInput.value.trim();
        if (!id) { alert('Informe o id do produto/plano'); return; }

        if (!SUPABASE_URL || !SUPABASE_ANON_KEY) {
          alert('Configuração Supabase não encontrada');
          return;
        }

        const endpoint = type === 'product'
          ? `${SUPABASE_URL}/rest/v1/products?id=eq.${encodeURIComponent(id)}` 
          : `${SUPABASE_URL}/rest/v1/plans?id=eq.${encodeURIComponent(id)}`;

        try {
          const resp = await fetch(endpoint, {
            method: 'GET',
            headers: {
              apikey: SUPABASE_ANON_KEY,
              Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
              Accept: 'application/json'
            }
          });
          if (!resp.ok) {
            const t = await resp.text();
            throw new Error(t || 'Erro ao consultar');
          }
          const items = await resp.json();
          if (!items || items.length === 0) { alert('Item não encontrado'); return; }
          const item = items[0];
          const amount = type === 'product' ? item.price : item.price_monthly;
          titleEl.innerText = item.name || item.description || 'Pagamento';
          priceEl.innerText = moneyToString(amount);
          info.hidden = false;
          payPix.dataset.amount = moneyToString(amount);
          payPix.dataset.desc = item.description || item.name || '';
          payPix.dataset.reference = item.id;
        } catch (err) {
          alert('Erro ao buscar preço: ' + err.message);
        }
      }

      // PIX payload builder (mínimo)
      function field(id, value) {
        if (value === undefined || value === null || value === "") return "";
        const s = String(value);
        return id + String(s.length).padStart(2, '0') + s;
      }
      function crc16(str) {
        let crc = 0xFFFF;
        for (let i=0;i<str.length;i++){
          crc ^= (str.charCodeAt(i) << 8);
          for (let j=0;j<8;j++){
            crc = (crc & 0x8000) ? ((crc << 1) ^ 0x1021) & 0xFFFF : (crc << 1) & 0xFFFF;
          }
        }
        return ('0000' + crc.toString(16).toUpperCase()).slice(-4);
      }
      function buildPixPayload({ key, amount, description, txid }) {
        const gui = field('00','br.gov.bcb.pix');
        const keyField = field('01', key);
        const merchantInfo = field('26', gui + keyField + (description ? field('02', description) : ''));
        const txidField = field('62', field('05', txid || "****"));
        const amountField = amount ? field('54', amount) : '';
        const entire = field('00','01') + field('01','12') + merchantInfo + amountField + field('53','986') + field('58','BR') + field('59','Viralizaai') + field('60','SAO PAULO') + txidField;
        const payloadNoCRC = entire + '63' + '04';
        const crc = crc16(payloadNoCRC);
        return payloadNoCRC + crc;
      }

      function setQr(payload) {
        qr.set({ value: payload });
        qrPreview.innerHTML = '';
        qrPreview.appendChild(qr.element);
      }

      fetchBtn.addEventListener('click', fetchPrice);

      payPix.addEventListener('click', () => {
        const amount = payPix.dataset.amount;
        const desc = payPix.dataset.desc;
        const ref = payPix.dataset.reference;
        if (!amount) return alert('Carregue o preço primeiro');

        const txid = 'pix-' + ref + '-' + Date.now();
        const pixKey = 'caccb1b4-6b25-4e5a-98a0-17121d31780e';
        const payload = buildPixPayload({ key: pixKey, amount: amount, description: desc, txid });
        payloadInput.value = payload;
        setQr(payload);
        const link = 'https://api.qrserver.com/v1/create-qr-code/?size=400x400&data=' + encodeURIComponent(payload);
        copyLink.dataset.link = link;
      });

      copyPayload.addEventListener('click', async () => {
        if (!payloadInput.value) return alert('Gere o PIX primeiro');
        await navigator.clipboard.writeText(payloadInput.value);
        copyPayload.innerText = 'Copiado';
        setTimeout(()=>copyPayload.innerText = 'Copiar payload', 1400);
      });

      copyLink.addEventListener('click', async () => {
        const link = copyLink.dataset.link;
        if (!link) return alert('Gere o PIX primeiro');
        await navigator.clipboard.writeText(link);
        copyLink.innerText = 'Link copiado';
        setTimeout(()=>copyLink.innerText = 'Copiar link', 1400);
      });

      payStripe.addEventListener('click', () => {
        // Redirecionar para o sistema Stripe existente
        window.parent.postMessage({ action: 'openStripe', data: payPix.dataset }, '*');
      });
    })();
  </script>
</body>
</html>
